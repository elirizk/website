import { f as createComponent, r as renderTemplate, m as maybeRenderHead, u as unescapeHTML } from './astro_BaztoWCL.mjs';
import 'kleur/colors';
import 'clsx';

const html = "<h2 id=\"motivation\">Motivation</h2>\n<p>Email is one of the most prevalent attack vectors for malicious actors. An attacker only needs one unknowing user to fall for a phishing campaign to gain foothold access to company systems and cause significant damage. Consequently, cybersecurity and IT analysts must always be vigilant about suspicious emails. Many email security providers offer solutions to prevent suspicious emails from reaching users’ inboxes, such as Microsoft’s Defender for Office 365, Proofpoint, Mimecast, and Abnormal. However, these products can introduce the risk of false positives, where legitimate emails are undelivered or stuck in quarantine. This requires SOC analysts to regularly monitor and review quarantined emails to release any legitimate ones. This motivated me to build a simple API that alerts analysts when an email is quarantined and allows quick action on the alert, such as releasing or deleting the email, changing the status of the detection, and more.</p>\n<h2 id=\"project-architecture\">Project Architecture</h2>\n<p>This project will require to develop a FastAPI app instance endpoint to handle our program’s logic and a Python job to continuously query Microsoft Defender for Office 365 for new quarantined emails.</p>\n<p>Below is a high-level diagram of the project architecture:\n<img src=\"/src/assets/teams/fastapi-teams-post.png\" alt=\"Project Architecture\"></p>\n<h3 id=\"fastapi-setup\">FastAPI setup</h3>\n<p>FastAPI is a modern, fast (high-performance), web framework for building APIs with Python 3.6+ based on standard Python type hints. It is designed to be easy to use and learn, while also providing the performance of <strong>asynchronous</strong> code. FastAPI is built on top of Starlette for the web parts and Pydantic for the data parts. It allows you to quickly create robust and production-ready APIs with automatic interactive documentation generated by Swagger UI and ReDoc.</p>\n<p>To get started with FastAPI, you need to install it using pip:</p>\n<pre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\"><code><span class=\"line\"><span style=\"color:#B392F0\">pip</span><span style=\"color:#9ECBFF\"> install</span><span style=\"color:#9ECBFF\"> fastapi</span></span>\n<span class=\"line\"><span style=\"color:#B392F0\">pip</span><span style=\"color:#9ECBFF\"> install</span><span style=\"color:#9ECBFF\"> uvicorn[standard]</span></span>\n<span class=\"line\"></span></code></pre>\n<p>You can then create a simple FastAPI application:</p>\n<pre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\"><code><span class=\"line\"><span style=\"color:#F97583\">from</span><span style=\"color:#E1E4E8\"> fastapi </span><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> FastAPI</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">app </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> FastAPI()</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">@app.get</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"/\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">def</span><span style=\"color:#B392F0\"> read_root</span><span style=\"color:#E1E4E8\">():</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> {</span><span style=\"color:#9ECBFF\">\"Hello\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"World\"</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>To run the application, use the following command:</p>\n<pre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\"><code><span class=\"line\"><span style=\"color:#B392F0\">uvicorn</span><span style=\"color:#9ECBFF\"> main:app</span><span style=\"color:#79B8FF\"> --reload</span></span>\n<span class=\"line\"></span></code></pre>\n<p>This will start a development server and you can access the interactive API documentation at <code>http://127.0.0.1:8000/docs</code>.</p>\n<p>Now that we have setup the FastAPI instance, we can start building our endpoints. We will start by creating the endpoint that sends a Microsoft Teams alert for an analyzed email object. To do so, we will use the Microsoft Graph <a href=\"https://learn.microsoft.com/en-us/graph/api/resources/security-analyzedemail?view=graph-rest-beta\">analyzedEmail</a> resource type to retrieve the email’s information followed by a Microsoft Teams webhook to send the message card.</p>\n<p>To query the Microsoft Graph API, we need to register an application in Microsoft and generate client credentials. We can do so in <a href=\"https://portal.azure.com/#home\">Azure</a> using the <em>App registrations</em> service. Make sure to give the application the appropriate application permission: <em>SecurityAnalyzedMessage.ReadWrite.All</em>. You can follow this <a href=\"https://learn.microsoft.com/en-us/azure/active-directory-b2c/microsoft-graph-get-started?tabs=app-reg-ga#register-management-application\">post</a> in Microsoft to guide you in registering an application that uses Microsoft Graph API.</p>\n<pre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\"><code><span class=\"line\"><span style=\"color:#F97583\">from</span><span style=\"color:#E1E4E8\"> fastapi </span><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> HTTPException</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> httpx</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">MICROSOFT_GRAPH_API_URL</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"https://graph.microsoft.com/beta/security/collaboration/analyzedEmails/\"</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">async</span><span style=\"color:#F97583\"> def</span><span style=\"color:#B392F0\"> get_ms_token</span><span style=\"color:#E1E4E8\">():</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    tenant_id </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> os.environ[</span><span style=\"color:#9ECBFF\">\"MICROSOFTGRAPH_TENANT_ID\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client_id </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> os.environ[</span><span style=\"color:#9ECBFF\">\"MICROSOFTGRAPH_CLIENT_ID\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    client_secret </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> os.environ[</span><span style=\"color:#9ECBFF\">\"MICROSOFTGRAPH_CLIENT_SECRET\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    scope </span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\"> \"https://graph.microsoft.com/.default\"</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    async</span><span style=\"color:#F97583\"> with</span><span style=\"color:#E1E4E8\"> httpx.AsyncClient() </span><span style=\"color:#F97583\">as</span><span style=\"color:#E1E4E8\"> client:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        token_result </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> client.post(</span><span style=\"color:#F97583\">f</span><span style=\"color:#9ECBFF\">\"https://login.microsoftonline.com/</span><span style=\"color:#79B8FF\">{</span><span style=\"color:#E1E4E8\">tenant_id</span><span style=\"color:#79B8FF\">}</span><span style=\"color:#9ECBFF\">/oauth2/v2.0/token\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">data</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">{</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"grant_type\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"client_credentials\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"client_id\"</span><span style=\"color:#E1E4E8\">: client_id,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"client_secret\"</span><span style=\"color:#E1E4E8\">: client_secret,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"scope\"</span><span style=\"color:#E1E4E8\">: scope</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }).json()</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    if</span><span style=\"color:#9ECBFF\"> 'access_token'</span><span style=\"color:#F97583\"> not</span><span style=\"color:#F97583\"> in</span><span style=\"color:#E1E4E8\"> token_result:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        raise</span><span style=\"color:#79B8FF\"> Exception</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">f</span><span style=\"color:#9ECBFF\">\"Error while getting access token: </span><span style=\"color:#79B8FF\">{</span><span style=\"color:#E1E4E8\">json.dumps(token_result, </span><span style=\"color:#FFAB70\">indent</span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\">4</span><span style=\"color:#E1E4E8\">)</span><span style=\"color:#79B8FF\">}</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> token_result[</span><span style=\"color:#9ECBFF\">'access_token'</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">@app.get</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"/analyzedEmail/</span><span style=\"color:#79B8FF\">{analyzedEmailId}</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">async</span><span style=\"color:#F97583\"> def</span><span style=\"color:#B392F0\"> get_analyzed_email</span><span style=\"color:#E1E4E8\">(analyzedEmailId: </span><span style=\"color:#79B8FF\">str</span><span style=\"color:#E1E4E8\">):</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    access_token </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> get_ms_token()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    headers </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"Authorization\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">f</span><span style=\"color:#9ECBFF\">\"Bearer </span><span style=\"color:#79B8FF\">{</span><span style=\"color:#E1E4E8\">access_token</span><span style=\"color:#79B8FF\">}</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    async</span><span style=\"color:#F97583\"> with</span><span style=\"color:#E1E4E8\"> httpx.AsyncClient() </span><span style=\"color:#F97583\">as</span><span style=\"color:#E1E4E8\"> client:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        response </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> client.get(</span><span style=\"color:#F97583\">f</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">{MICROSOFT_GRAPH_API_URL}{</span><span style=\"color:#E1E4E8\">analyzedEmailId</span><span style=\"color:#79B8FF\">}</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">headers</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">headers)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> response.status_code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 200</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            raise</span><span style=\"color:#E1E4E8\"> HTTPException(</span><span style=\"color:#FFAB70\">status_code</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">response.status_code, </span><span style=\"color:#FFAB70\">detail</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"Error retrieving analyzed email\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Once we have obtained the analyzed email resource object, we are ready to send an alert in Microsoft Teams. The alert will be sent in the format of a message card to allow semi-automated actions by the members of the Teams channel. This will greatly facilitate the need for analysts to jump back and forth through different consoles.</p>\n<pre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\"><code><span class=\"line\"><span style=\"color:#79B8FF\">API_ENDPOINT</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"&#x3C;enter your API URL endpoint here>\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">WEBHOOK_URL</span><span style=\"color:#F97583\"> =</span><span style=\"color:#9ECBFF\"> \"&#x3C;entern your Microsoft Teams webhook URL>\"</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">TENANT_ID</span><span style=\"color:#F97583\"> =</span><span style=\"color:#E1E4E8\"> os.environ[</span><span style=\"color:#9ECBFF\">\"MICROSOFTGRAPH_TENANT_ID\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#B392F0\">@app.post</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"/sendToTeams/analyzedEmail/</span><span style=\"color:#79B8FF\">{analyzedEmailId}</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">async</span><span style=\"color:#F97583\"> def</span><span style=\"color:#B392F0\"> send_analyzedEmail</span><span style=\"color:#E1E4E8\">(analyzedEmailId: </span><span style=\"color:#79B8FF\">str</span><span style=\"color:#E1E4E8\">):</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    email_data </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> get_email_data(analyzedEmailId)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    message_card </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"@type\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"MessageCard\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"@context\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"http://schema.org/extensions\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"summary\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Email Sent to Quarantine\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"themeColor\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"0076D7\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"sections\"</span><span style=\"color:#E1E4E8\">: [</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            {</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"activityTitle\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Email Sent to Quarantine\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"activitySubtitle\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Microsoft Defender for Office 365 detected a suspicious email and sent it to quarantine\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"activityImage\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"https://www.hkmu.edu.hk/ito/wp-content/uploads/sites/10/2021/06/phishingicon1.jpg\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"facts\"</span><span style=\"color:#E1E4E8\">: [</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    {</span><span style=\"color:#9ECBFF\">\"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Logged Timestamp\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"value\"</span><span style=\"color:#E1E4E8\">: email_data[</span><span style=\"color:#9ECBFF\">\"loggedDateTime\"</span><span style=\"color:#E1E4E8\">]},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    {</span><span style=\"color:#9ECBFF\">\"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Network Message ID\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"value\"</span><span style=\"color:#E1E4E8\">: email_data[</span><span style=\"color:#9ECBFF\">\"networkMessageId\"</span><span style=\"color:#E1E4E8\">]},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    {</span><span style=\"color:#9ECBFF\">\"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Email Subject\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"value\"</span><span style=\"color:#E1E4E8\">: email_data[</span><span style=\"color:#9ECBFF\">\"subject\"</span><span style=\"color:#E1E4E8\">]},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    {</span><span style=\"color:#9ECBFF\">\"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Recipient Address\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"value\"</span><span style=\"color:#E1E4E8\">: email_data[</span><span style=\"color:#9ECBFF\">\"recipientEmailAddress\"</span><span style=\"color:#E1E4E8\">]},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    {</span><span style=\"color:#9ECBFF\">\"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Sender Address\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"value\"</span><span style=\"color:#E1E4E8\">: email_data[</span><span style=\"color:#9ECBFF\">\"senderDetail\"</span><span style=\"color:#E1E4E8\">][</span><span style=\"color:#9ECBFF\">\"fromAddress\"</span><span style=\"color:#E1E4E8\">]},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    {</span><span style=\"color:#9ECBFF\">\"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Return Path\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"value\"</span><span style=\"color:#E1E4E8\">: email_data[</span><span style=\"color:#9ECBFF\">\"returnPath\"</span><span style=\"color:#E1E4E8\">]},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    {</span><span style=\"color:#9ECBFF\">\"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Policy\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"value\"</span><span style=\"color:#E1E4E8\">: email_data[</span><span style=\"color:#9ECBFF\">\"policy\"</span><span style=\"color:#E1E4E8\">]},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    {</span><span style=\"color:#9ECBFF\">\"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Latest Action\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"value\"</span><span style=\"color:#E1E4E8\">: email_data[</span><span style=\"color:#9ECBFF\">\"latestDelivery\"</span><span style=\"color:#E1E4E8\">][</span><span style=\"color:#9ECBFF\">\"action\"</span><span style=\"color:#E1E4E8\">]},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    {</span><span style=\"color:#9ECBFF\">\"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Policy\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"value\"</span><span style=\"color:#E1E4E8\">: email_data[</span><span style=\"color:#9ECBFF\">\"policy\"</span><span style=\"color:#E1E4E8\">]},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    {</span><span style=\"color:#9ECBFF\">\"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"DMARC\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"value\"</span><span style=\"color:#E1E4E8\">: email_data[</span><span style=\"color:#9ECBFF\">\"authenticationDetails\"</span><span style=\"color:#E1E4E8\">][</span><span style=\"color:#9ECBFF\">\"dmarc\"</span><span style=\"color:#E1E4E8\">]},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    {</span><span style=\"color:#9ECBFF\">\"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"DKIM\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"value\"</span><span style=\"color:#E1E4E8\">: email_data[</span><span style=\"color:#9ECBFF\">\"authenticationDetails\"</span><span style=\"color:#E1E4E8\">][</span><span style=\"color:#9ECBFF\">\"dkim\"</span><span style=\"color:#E1E4E8\">]},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    {</span><span style=\"color:#9ECBFF\">\"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"SPF\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"value\"</span><span style=\"color:#E1E4E8\">: email_data[</span><span style=\"color:#9ECBFF\">\"authenticationDetails\"</span><span style=\"color:#E1E4E8\">][</span><span style=\"color:#9ECBFF\">\"senderPolicyFramework\"</span><span style=\"color:#E1E4E8\">]},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    {</span><span style=\"color:#9ECBFF\">\"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Sender IP Address\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"value\"</span><span style=\"color:#E1E4E8\">: email_data[</span><span style=\"color:#9ECBFF\">\"senderDetail\"</span><span style=\"color:#E1E4E8\">][</span><span style=\"color:#9ECBFF\">\"ipv4\"</span><span style=\"color:#E1E4E8\">]},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    {</span><span style=\"color:#9ECBFF\">\"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Message URLs\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"value\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">.join([url[</span><span style=\"color:#9ECBFF\">\"url\"</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">for</span><span style=\"color:#E1E4E8\"> url </span><span style=\"color:#F97583\">in</span><span style=\"color:#E1E4E8\"> email_data[</span><span style=\"color:#9ECBFF\">\"urls\"</span><span style=\"color:#E1E4E8\">]])},</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    {</span><span style=\"color:#9ECBFF\">\"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Attachment File Hashes\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#9ECBFF\">\"value\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">\\n</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">.join([attachment[</span><span style=\"color:#9ECBFF\">\"sha256\"</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">for</span><span style=\"color:#E1E4E8\"> attachment </span><span style=\"color:#F97583\">in</span><span style=\"color:#E1E4E8\"> email_data[</span><span style=\"color:#9ECBFF\">\"attachments\"</span><span style=\"color:#E1E4E8\">]])}</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                ],</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"markdown\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#79B8FF\">True</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ],</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"potentialAction\"</span><span style=\"color:#E1E4E8\">: [</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            {</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"@type\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"OpenUri\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"View Email\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"targets\"</span><span style=\"color:#E1E4E8\">: [</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    {</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                        \"os\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"default\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                        \"uri\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">f</span><span style=\"color:#9ECBFF\">\"https://security.microsoft.com/emailentity?f=summary&#x26;startTime=</span><span style=\"color:#79B8FF\">{</span><span style=\"color:#E1E4E8\">email_data[</span><span style=\"color:#9ECBFF\">'loggedDateTime'</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#79B8FF\">}</span><span style=\"color:#9ECBFF\">&#x26;endTime=</span><span style=\"color:#79B8FF\">{</span><span style=\"color:#E1E4E8\">email_data[</span><span style=\"color:#9ECBFF\">'loggedDateTime'</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#79B8FF\">}</span><span style=\"color:#9ECBFF\">&#x26;id=</span><span style=\"color:#79B8FF\">{</span><span style=\"color:#E1E4E8\">email_data[</span><span style=\"color:#9ECBFF\">'networkMessageId'</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#79B8FF\">}</span><span style=\"color:#9ECBFF\">&#x26;recipient=</span><span style=\"color:#79B8FF\">{</span><span style=\"color:#E1E4E8\">email_data[</span><span style=\"color:#9ECBFF\">'recipientEmailAddress'</span><span style=\"color:#E1E4E8\">]</span><span style=\"color:#79B8FF\">}</span><span style=\"color:#9ECBFF\">&#x26;tid=</span><span style=\"color:#79B8FF\">{TENANT_ID}</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                ]</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            {</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"@type\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"HttpPOST\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Release Email\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"target\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">f</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">{API_ENDPOINT}</span><span style=\"color:#9ECBFF\">/analyzedEmail/remediate\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"body\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"{</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">networkMessageId</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> +</span><span style=\"color:#E1E4E8\"> email_data[</span><span style=\"color:#9ECBFF\">\"networkMessageId\"</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">+</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">, </span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">recipientEmailAddress</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> +</span><span style=\"color:#E1E4E8\"> email_data[</span><span style=\"color:#9ECBFF\">\"recipientEmailAddress\"</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">+</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">, </span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">action</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">moveToInbox</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">}\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            {</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"@type\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"HttpPOST\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Delete Email\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"target\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">f</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">{API_ENDPOINT}</span><span style=\"color:#9ECBFF\">/analyzedEmail/remediate\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"body\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"{</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">networkMessageId</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> +</span><span style=\"color:#E1E4E8\"> email_data[</span><span style=\"color:#9ECBFF\">\"networkMessageId\"</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">+</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">, </span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">recipientEmailAddress</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> +</span><span style=\"color:#E1E4E8\"> email_data[</span><span style=\"color:#9ECBFF\">\"recipientEmailAddress\"</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">+</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">, </span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">action</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">hardDelete</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">}\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            },</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            {</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"@type\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"HttpPOST\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"name\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Move to Junk\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"target\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">f</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">{API_ENDPOINT}</span><span style=\"color:#9ECBFF\">/analyzedEmail/remediate\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"body\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"{</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">networkMessageId</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> +</span><span style=\"color:#E1E4E8\"> email_data[</span><span style=\"color:#9ECBFF\">\"networkMessageId\"</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">+</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">, </span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">recipientEmailAddress</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#F97583\"> +</span><span style=\"color:#E1E4E8\"> email_data[</span><span style=\"color:#9ECBFF\">\"recipientEmailAddress\"</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">+</span><span style=\"color:#9ECBFF\"> \"</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">, </span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">action</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">:</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">moveToJunk</span><span style=\"color:#79B8FF\">\\\"</span><span style=\"color:#9ECBFF\">}\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        ]</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    async</span><span style=\"color:#F97583\"> with</span><span style=\"color:#E1E4E8\"> httpx.AsyncClient() </span><span style=\"color:#F97583\">as</span><span style=\"color:#E1E4E8\"> client:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        response </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> client.post(</span><span style=\"color:#79B8FF\">WEBHOOK_URL</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">json</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">message_card)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> response.status_code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 200</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            raise</span><span style=\"color:#E1E4E8\"> HTTPException(</span><span style=\"color:#FFAB70\">status_code</span><span style=\"color:#F97583\">=</span><span style=\"color:#79B8FF\">404</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">detail</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"Error sending message card to Teams\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> {</span><span style=\"color:#9ECBFF\">\"message\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"Message card sent to Teams successfully\"</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Here’s a sample of how the message card will look like in Teams:\n<img src=\"/src/assets/teams/message-card-output.png\" alt=\"Message Card in Microsoft Teams\"></p>\n<p>Once we have sent the alert to Teams, we also need to accept incoming POST requests sent via the user actions in the message card. We will implement a release, hard delete and move to junk functionalities.</p>\n<pre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\"><code><span class=\"line\"><span style=\"color:#B392F0\">@app.post</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#9ECBFF\">\"/analyzedEmail/remediate\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">async</span><span style=\"color:#F97583\"> def</span><span style=\"color:#B392F0\"> email_action</span><span style=\"color:#E1E4E8\">(networkMessageId: </span><span style=\"color:#79B8FF\">str</span><span style=\"color:#E1E4E8\">, recipientEmailAddress: </span><span style=\"color:#79B8FF\">str</span><span style=\"color:#E1E4E8\">, action: </span><span style=\"color:#79B8FF\">str</span><span style=\"color:#E1E4E8\">):</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    access_token </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> get_ms_token()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    headers </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"Authorization\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">f</span><span style=\"color:#9ECBFF\">\"Bearer </span><span style=\"color:#79B8FF\">{</span><span style=\"color:#E1E4E8\">access_token</span><span style=\"color:#79B8FF\">}</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"Content-Type\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#9ECBFF\">\"application/json\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    payload </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"action\"</span><span style=\"color:#E1E4E8\">: request.action,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"networkMessageId\"</span><span style=\"color:#E1E4E8\">: request.networkMessageId,</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">        \"recipientEmailAddress\"</span><span style=\"color:#E1E4E8\">: request.recipientEmailAddress</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    async</span><span style=\"color:#F97583\"> with</span><span style=\"color:#E1E4E8\"> httpx.AsyncClient() </span><span style=\"color:#F97583\">as</span><span style=\"color:#E1E4E8\"> client:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">        response </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> client.post(</span><span style=\"color:#F97583\">f</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#79B8FF\">{MICROSOFT_GRAPH_API_URL}</span><span style=\"color:#9ECBFF\">remediate\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">headers</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">headers, </span><span style=\"color:#FFAB70\">json</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">payload)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        if</span><span style=\"color:#E1E4E8\"> response.status_code </span><span style=\"color:#F97583\">!=</span><span style=\"color:#79B8FF\"> 200</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            raise</span><span style=\"color:#E1E4E8\"> HTTPException(</span><span style=\"color:#FFAB70\">status_code</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">response.status_code, </span><span style=\"color:#FFAB70\">detail</span><span style=\"color:#F97583\">=</span><span style=\"color:#9ECBFF\">\"Error performing email action\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    return</span><span style=\"color:#E1E4E8\"> {</span><span style=\"color:#9ECBFF\">\"message\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">f</span><span style=\"color:#9ECBFF\">\"Email action '</span><span style=\"color:#79B8FF\">{</span><span style=\"color:#E1E4E8\">request.action</span><span style=\"color:#79B8FF\">}</span><span style=\"color:#9ECBFF\">' performed successfully\"</span><span style=\"color:#E1E4E8\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p>This concludes our FastAPI instance. Next, we will implement a python script that will run as a service to continuously poll the Microsoft Graph API for new quarantined emails and use our API endpoint to send the alert to Teams.</p>\n<h3 id=\"python-job\">Python Job</h3>\n<p>We will write our Python service script to check analyzed emails that are stuck in quarantine every 5 minutes by manipulating the startTime and endTime query parameters. In practice, I have noticed that the Microsoft Graph API has some latency before showing analyzed emails, so instead of querying from the past 5 minutes, the code queries from the previous 15th to 10th minutes. For every quarantined email, the script calls our FastAPI endpoint to send the relevant detection to Teams.</p>\n<pre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\"><code><span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> httpx</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">import</span><span style=\"color:#E1E4E8\"> asyncio</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">async</span><span style=\"color:#F97583\"> def</span><span style=\"color:#B392F0\"> main</span><span style=\"color:#E1E4E8\">():</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">    while</span><span style=\"color:#79B8FF\"> True</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        try</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            now </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> time.time()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            start_time </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> time.strftime(</span><span style=\"color:#9ECBFF\">\"%Y-%m-</span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">T%H:%M:%SZ\"</span><span style=\"color:#E1E4E8\">, time.gmtime(now </span><span style=\"color:#F97583\">-</span><span style=\"color:#79B8FF\"> 5</span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\">60</span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\">2</span><span style=\"color:#E1E4E8\">))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            end_time </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> time.strftime(</span><span style=\"color:#9ECBFF\">\"%Y-%m-</span><span style=\"color:#79B8FF\">%d</span><span style=\"color:#9ECBFF\">T%H:%M:%SZ\"</span><span style=\"color:#E1E4E8\">, time.gmtime(now </span><span style=\"color:#F97583\">-</span><span style=\"color:#79B8FF\"> 5</span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\">60</span><span style=\"color:#F97583\">*</span><span style=\"color:#79B8FF\">3</span><span style=\"color:#E1E4E8\">))</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            access_token </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> get_ms_token()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            headers </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> {</span></span>\n<span class=\"line\"><span style=\"color:#9ECBFF\">                \"Authorization\"</span><span style=\"color:#E1E4E8\">: </span><span style=\"color:#F97583\">f</span><span style=\"color:#9ECBFF\">\"Bearer </span><span style=\"color:#79B8FF\">{</span><span style=\"color:#E1E4E8\">access_token</span><span style=\"color:#79B8FF\">}</span><span style=\"color:#9ECBFF\">\"</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">            }</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">            async</span><span style=\"color:#F97583\"> with</span><span style=\"color:#E1E4E8\"> httpx.AsyncClient() </span><span style=\"color:#F97583\">as</span><span style=\"color:#E1E4E8\"> client:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                response </span><span style=\"color:#F97583\">=</span><span style=\"color:#F97583\"> await</span><span style=\"color:#E1E4E8\"> client.get(</span><span style=\"color:#F97583\">f</span><span style=\"color:#9ECBFF\">\"https://graph.microsoft.com/v1.0/security/collaboration/analyzedEmails?startTime=</span><span style=\"color:#79B8FF\">{</span><span style=\"color:#E1E4E8\">start_time</span><span style=\"color:#79B8FF\">}</span><span style=\"color:#9ECBFF\">&#x26;endTime=</span><span style=\"color:#79B8FF\">{</span><span style=\"color:#E1E4E8\">end_time</span><span style=\"color:#79B8FF\">}</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">, </span><span style=\"color:#FFAB70\">headers</span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\">headers)</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                response.raise_for_status()</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">                emails </span><span style=\"color:#F97583\">=</span><span style=\"color:#E1E4E8\"> response.json()[</span><span style=\"color:#9ECBFF\">\"value\"</span><span style=\"color:#E1E4E8\">]</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                for</span><span style=\"color:#E1E4E8\"> email </span><span style=\"color:#F97583\">in</span><span style=\"color:#E1E4E8\"> emails:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                    if</span><span style=\"color:#E1E4E8\"> email[</span><span style=\"color:#9ECBFF\">\"latestDelivery\"</span><span style=\"color:#E1E4E8\">][</span><span style=\"color:#9ECBFF\">\"location\"</span><span style=\"color:#E1E4E8\">] </span><span style=\"color:#F97583\">==</span><span style=\"color:#9ECBFF\"> \"quarantine\"</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">                        await</span><span style=\"color:#E1E4E8\"> send_to_teams(email[</span><span style=\"color:#9ECBFF\">\"id\"</span><span style=\"color:#E1E4E8\">])</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        except</span><span style=\"color:#79B8FF\"> Exception</span><span style=\"color:#F97583\"> as</span><span style=\"color:#E1E4E8\"> e:</span></span>\n<span class=\"line\"><span style=\"color:#79B8FF\">            print</span><span style=\"color:#E1E4E8\">(</span><span style=\"color:#F97583\">f</span><span style=\"color:#9ECBFF\">\"Error: </span><span style=\"color:#79B8FF\">{</span><span style=\"color:#E1E4E8\">e</span><span style=\"color:#79B8FF\">}</span><span style=\"color:#9ECBFF\">\"</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"><span style=\"color:#F97583\">        await</span><span style=\"color:#E1E4E8\"> asyncio.sleep(</span><span style=\"color:#79B8FF\">300</span><span style=\"color:#E1E4E8\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#F97583\">if</span><span style=\"color:#79B8FF\"> __name__</span><span style=\"color:#F97583\"> ==</span><span style=\"color:#9ECBFF\"> \"__main__\"</span><span style=\"color:#E1E4E8\">:</span></span>\n<span class=\"line\"><span style=\"color:#E1E4E8\">    asyncio.run(main())</span></span>\n<span class=\"line\"></span></code></pre>\n<h2 id=\"conclusion\">Conclusion</h2>\n<p>By leveraging FastAPI and Microsoft Graph, we have created a powerful tool that enhances the efficiency of cybersecurity analysts. This solution not only automates the detection and alerting process but also provides actionable insights directly within Microsoft Teams. This integration reduces the need for analysts to switch between different platforms, allowing them to respond to threats more quickly and effectively. The project can be easily augmented to interact with a backend database and offer more functionalities such as assigning a status, an analyst, tags or comments to a detection facilitating team collaboration against possible attacks. As cyber threats continue to evolve, having such automated and integrated systems in place is crucial for maintaining robust security postures. This project demonstrates the potential of combining modern web frameworks with cloud-based APIs to build scalable and responsive security solutions. I hope this guide inspires you to explore further possibilities with FastAPI and Microsoft Graph in your own projects.</p>\n<p><strong>What do you think about this solution? Have you tried something similar? Connect with me on <a href=\"https://www.linkedin.com/in/elirizk/\">LinkedIn</a> and let me know!</strong></p>\n<h2 id=\"references\">References</h2>\n<p><a href=\"https://learn.microsoft.com/en-us/graph/api/resources/security-analyzedemail?view=graph-rest-beta\">Microsoft Graph analyzedEmail resource type</a></p>\n<p><a href=\"https://learn.microsoft.com/en-us/azure/active-directory-b2c/microsoft-graph-get-started?tabs=app-reg-ga#register-management-application\">Microsoft Graph app registration walkthrough</a></p>\n<p><a href=\"https://github.com/OfficeDev/outlook-dev-docs/blob/main/docs/actionable-messages/message-card-reference.md\">Actionable message card documentation</a></p>";

				const frontmatter = {"title":"How I used FastAPI to automate phishing email handling in Microsoft Teams","description":"In this post, I will highlight how I used Python`s FastAPI to develop a custom phishing email handling functionality in Microsoft Teams using actionable message cards.","pubDate":"Oct 30 2024","heroImage":"src/assets/teams/message-card-output.png","tags":["Python","Microsoft","Cybersecurity","API"]};
				const file = "/Users/elirizk/Desktop/Personal Website/public_site/src/content/projects/teams-actionable-card.md";
				const url = undefined;
				function rawContent() {
					return "\n## Motivation\n\nEmail is one of the most prevalent attack vectors for malicious actors. An attacker only needs one unknowing user to fall for a phishing campaign to gain foothold access to company systems and cause significant damage. Consequently, cybersecurity and IT analysts must always be vigilant about suspicious emails. Many email security providers offer solutions to prevent suspicious emails from reaching users' inboxes, such as Microsoft's Defender for Office 365, Proofpoint, Mimecast, and Abnormal. However, these products can introduce the risk of false positives, where legitimate emails are undelivered or stuck in quarantine. This requires SOC analysts to regularly monitor and review quarantined emails to release any legitimate ones. This motivated me to build a simple API that alerts analysts when an email is quarantined and allows quick action on the alert, such as releasing or deleting the email, changing the status of the detection, and more.\n\n## Project Architecture\n\nThis project will require to develop a FastAPI app instance endpoint to handle our program's logic and a Python job to continuously query Microsoft Defender for Office 365 for new quarantined emails.\n\nBelow is a high-level diagram of the project architecture:\n![Project Architecture](/src/assets/teams/fastapi-teams-post.png)\n\n\n### FastAPI setup\n\nFastAPI is a modern, fast (high-performance), web framework for building APIs with Python 3.6+ based on standard Python type hints. It is designed to be easy to use and learn, while also providing the performance of **asynchronous** code. FastAPI is built on top of Starlette for the web parts and Pydantic for the data parts. It allows you to quickly create robust and production-ready APIs with automatic interactive documentation generated by Swagger UI and ReDoc.\n\nTo get started with FastAPI, you need to install it using pip:\n\n```bash\npip install fastapi\npip install uvicorn[standard]\n```\n\nYou can then create a simple FastAPI application:\n\n```python\nfrom fastapi import FastAPI\n\napp = FastAPI()\n\n@app.get(\"/\")\ndef read_root():\n    return {\"Hello\": \"World\"}\n```\n\nTo run the application, use the following command:\n\n```bash\nuvicorn main:app --reload\n```\n\nThis will start a development server and you can access the interactive API documentation at `http://127.0.0.1:8000/docs`.\n\nNow that we have setup the FastAPI instance, we can start building our endpoints. We will start by creating the endpoint that sends a Microsoft Teams alert for an analyzed email object. To do so, we will use the Microsoft Graph [analyzedEmail](https://learn.microsoft.com/en-us/graph/api/resources/security-analyzedemail?view=graph-rest-beta) resource type to retrieve the email's information followed by a Microsoft Teams webhook to send the message card.\n\nTo query the Microsoft Graph API, we need to register an application in Microsoft and generate client credentials. We can do so in [Azure](https://portal.azure.com/#home) using the _App registrations_ service. Make sure to give the application the appropriate application permission: _SecurityAnalyzedMessage.ReadWrite.All_. You can follow this [post](https://learn.microsoft.com/en-us/azure/active-directory-b2c/microsoft-graph-get-started?tabs=app-reg-ga#register-management-application) in Microsoft to guide you in registering an application that uses Microsoft Graph API.\n\n```python\nfrom fastapi import HTTPException\nimport httpx\n\nMICROSOFT_GRAPH_API_URL = \"https://graph.microsoft.com/beta/security/collaboration/analyzedEmails/\"\n\nasync def get_ms_token():\n    tenant_id = os.environ[\"MICROSOFTGRAPH_TENANT_ID\"]\n    client_id = os.environ[\"MICROSOFTGRAPH_CLIENT_ID\"]\n    client_secret = os.environ[\"MICROSOFTGRAPH_CLIENT_SECRET\"]\n    scope = \"https://graph.microsoft.com/.default\"\n    async with httpx.AsyncClient() as client:\n        token_result = await client.post(f\"https://login.microsoftonline.com/{tenant_id}/oauth2/v2.0/token\", data={\n        \"grant_type\": \"client_credentials\",\n        \"client_id\": client_id,\n        \"client_secret\": client_secret,\n        \"scope\": scope\n    }).json()\n    if 'access_token' not in token_result:\n        raise Exception(f\"Error while getting access token: {json.dumps(token_result, indent=4)}\")\n    return token_result['access_token']\n\n@app.get(\"/analyzedEmail/{analyzedEmailId}\")\nasync def get_analyzed_email(analyzedEmailId: str):\n    access_token = await get_ms_token()\n    headers = {\n        \"Authorization\": f\"Bearer {access_token}\"\n    }\n    async with httpx.AsyncClient() as client:\n        response = await client.get(f\"{MICROSOFT_GRAPH_API_URL}{analyzedEmailId}\", headers=headers)\n        if response.status_code != 200:\n            raise HTTPException(status_code=response.status_code, detail=\"Error retrieving analyzed email\")\n```\n\nOnce we have obtained the analyzed email resource object, we are ready to send an alert in Microsoft Teams. The alert will be sent in the format of a message card to allow semi-automated actions by the members of the Teams channel. This will greatly facilitate the need for analysts to jump back and forth through different consoles.\n\n```python\nAPI_ENDPOINT = \"<enter your API URL endpoint here>\"\nWEBHOOK_URL = \"<entern your Microsoft Teams webhook URL>\"\nTENANT_ID = os.environ[\"MICROSOFTGRAPH_TENANT_ID\"]\n\n@app.post(\"/sendToTeams/analyzedEmail/{analyzedEmailId}\")\nasync def send_analyzedEmail(analyzedEmailId: str):\n    email_data = await get_email_data(analyzedEmailId)\n    message_card = {\n        \"@type\": \"MessageCard\",\n        \"@context\": \"http://schema.org/extensions\",\n        \"summary\": \"Email Sent to Quarantine\",\n        \"themeColor\": \"0076D7\",\n        \"sections\": [\n            {\n                \"activityTitle\": \"Email Sent to Quarantine\",\n                \"activitySubtitle\": \"Microsoft Defender for Office 365 detected a suspicious email and sent it to quarantine\",\n                \"activityImage\": \"https://www.hkmu.edu.hk/ito/wp-content/uploads/sites/10/2021/06/phishingicon1.jpg\",\n                \"facts\": [\n                    {\"name\": \"Logged Timestamp\", \"value\": email_data[\"loggedDateTime\"]},\n                    {\"name\": \"Network Message ID\", \"value\": email_data[\"networkMessageId\"]},\n                    {\"name\": \"Email Subject\", \"value\": email_data[\"subject\"]},\n                    {\"name\": \"Recipient Address\", \"value\": email_data[\"recipientEmailAddress\"]},\n                    {\"name\": \"Sender Address\", \"value\": email_data[\"senderDetail\"][\"fromAddress\"]},\n                    {\"name\": \"Return Path\", \"value\": email_data[\"returnPath\"]},\n                    {\"name\": \"Policy\", \"value\": email_data[\"policy\"]},\n                    {\"name\": \"Latest Action\", \"value\": email_data[\"latestDelivery\"][\"action\"]},\n                    {\"name\": \"Policy\", \"value\": email_data[\"policy\"]},\n                    {\"name\": \"DMARC\", \"value\": email_data[\"authenticationDetails\"][\"dmarc\"]},\n                    {\"name\": \"DKIM\", \"value\": email_data[\"authenticationDetails\"][\"dkim\"]},\n                    {\"name\": \"SPF\", \"value\": email_data[\"authenticationDetails\"][\"senderPolicyFramework\"]},\n                    {\"name\": \"Sender IP Address\", \"value\": email_data[\"senderDetail\"][\"ipv4\"]},\n                    {\"name\": \"Message URLs\", \"value\": \"\\n\".join([url[\"url\"] for url in email_data[\"urls\"]])},\n                    {\"name\": \"Attachment File Hashes\", \"value\": \"\\n\".join([attachment[\"sha256\"] for attachment in email_data[\"attachments\"]])}\n                ],\n                \"markdown\": True\n            }\n        ],\n        \"potentialAction\": [\n            {\n                \"@type\": \"OpenUri\",\n                \"name\": \"View Email\",\n                \"targets\": [\n                    {\n                        \"os\": \"default\",\n                        \"uri\": f\"https://security.microsoft.com/emailentity?f=summary&startTime={email_data['loggedDateTime']}&endTime={email_data['loggedDateTime']}&id={email_data['networkMessageId']}&recipient={email_data['recipientEmailAddress']}&tid={TENANT_ID}\"\n                    }\n                ]\n            },\n            {\n                \"@type\": \"HttpPOST\",\n                \"name\": \"Release Email\",\n                \"target\": f\"{API_ENDPOINT}/analyzedEmail/remediate\",\n                \"body\": \"{\\\"networkMessageId\\\":\\\"\" + email_data[\"networkMessageId\"] + \"\\\", \\\"recipientEmailAddress\\\":\\\"\" + email_data[\"recipientEmailAddress\"] + \"\\\", \\\"action\\\":\\\"moveToInbox\\\"}\"\n            },\n            {\n                \"@type\": \"HttpPOST\",\n                \"name\": \"Delete Email\",\n                \"target\": f\"{API_ENDPOINT}/analyzedEmail/remediate\",\n                \"body\": \"{\\\"networkMessageId\\\":\\\"\" + email_data[\"networkMessageId\"] + \"\\\", \\\"recipientEmailAddress\\\":\\\"\" + email_data[\"recipientEmailAddress\"] + \"\\\", \\\"action\\\":\\\"hardDelete\\\"}\"\n            },\n            {\n                \"@type\": \"HttpPOST\",\n                \"name\": \"Move to Junk\",\n                \"target\": f\"{API_ENDPOINT}/analyzedEmail/remediate\",\n                \"body\": \"{\\\"networkMessageId\\\":\\\"\" + email_data[\"networkMessageId\"] + \"\\\", \\\"recipientEmailAddress\\\":\\\"\" + email_data[\"recipientEmailAddress\"] + \"\\\", \\\"action\\\":\\\"moveToJunk\\\"}\"\n            }\n        ]\n    }\n    async with httpx.AsyncClient() as client:\n        response = await client.post(WEBHOOK_URL, json=message_card)\n        if response.status_code != 200:\n            raise HTTPException(status_code=404, detail=\"Error sending message card to Teams\")\n    return {\"message\": \"Message card sent to Teams successfully\"}\n```\n\nHere's a sample of how the message card will look like in Teams:\n![Message Card in Microsoft Teams](/src/assets/teams/message-card-output.png)\n\nOnce we have sent the alert to Teams, we also need to accept incoming POST requests sent via the user actions in the message card. We will implement a release, hard delete and move to junk functionalities.\n\n```python\n@app.post(\"/analyzedEmail/remediate\")\nasync def email_action(networkMessageId: str, recipientEmailAddress: str, action: str):\n    access_token = await get_ms_token()\n    headers = {\n        \"Authorization\": f\"Bearer {access_token}\",\n        \"Content-Type\": \"application/json\"\n    }\n    payload = {\n        \"action\": request.action,\n        \"networkMessageId\": request.networkMessageId,\n        \"recipientEmailAddress\": request.recipientEmailAddress\n    }\n    async with httpx.AsyncClient() as client:\n        response = await client.post(f\"{MICROSOFT_GRAPH_API_URL}remediate\", headers=headers, json=payload)\n        if response.status_code != 200:\n            raise HTTPException(status_code=response.status_code, detail=\"Error performing email action\")\n    return {\"message\": f\"Email action '{request.action}' performed successfully\"}\n```\n\nThis concludes our FastAPI instance. Next, we will implement a python script that will run as a service to continuously poll the Microsoft Graph API for new quarantined emails and use our API endpoint to send the alert to Teams.\n\n### Python Job\nWe will write our Python service script to check analyzed emails that are stuck in quarantine every 5 minutes by manipulating the startTime and endTime query parameters. In practice, I have noticed that the Microsoft Graph API has some latency before showing analyzed emails, so instead of querying from the past 5 minutes, the code queries from the previous 15th to 10th minutes. For every quarantined email, the script calls our FastAPI endpoint to send the relevant detection to Teams.\n\n```python\nimport httpx\nimport asyncio\n\nasync def main():\n    while True:\n        try:\n            now = time.time()\n            start_time = time.strftime(\"%Y-%m-%dT%H:%M:%SZ\", time.gmtime(now - 5*60*2))\n            end_time = time.strftime(\"%Y-%m-%dT%H:%M:%SZ\", time.gmtime(now - 5*60*3))\n            access_token = await get_ms_token()\n            headers = {\n                \"Authorization\": f\"Bearer {access_token}\"\n            }\n            async with httpx.AsyncClient() as client:\n                response = await client.get(f\"https://graph.microsoft.com/v1.0/security/collaboration/analyzedEmails?startTime={start_time}&endTime={end_time}\", headers=headers)\n                response.raise_for_status()\n                emails = response.json()[\"value\"]\n                for email in emails:\n                    if email[\"latestDelivery\"][\"location\"] == \"quarantine\":\n                        await send_to_teams(email[\"id\"])\n        except Exception as e:\n            print(f\"Error: {e}\")\n        await asyncio.sleep(300)\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n```\n\n## Conclusion\n\nBy leveraging FastAPI and Microsoft Graph, we have created a powerful tool that enhances the efficiency of cybersecurity analysts. This solution not only automates the detection and alerting process but also provides actionable insights directly within Microsoft Teams. This integration reduces the need for analysts to switch between different platforms, allowing them to respond to threats more quickly and effectively. The project can be easily augmented to interact with a backend database and offer more functionalities such as assigning a status, an analyst, tags or comments to a detection facilitating team collaboration against possible attacks. As cyber threats continue to evolve, having such automated and integrated systems in place is crucial for maintaining robust security postures. This project demonstrates the potential of combining modern web frameworks with cloud-based APIs to build scalable and responsive security solutions. I hope this guide inspires you to explore further possibilities with FastAPI and Microsoft Graph in your own projects.\n\n**What do you think about this solution? Have you tried something similar? Connect with me on [LinkedIn](https://www.linkedin.com/in/elirizk/) and let me know!**\n\n\n## References\n\n[Microsoft Graph analyzedEmail resource type](https://learn.microsoft.com/en-us/graph/api/resources/security-analyzedemail?view=graph-rest-beta)\n\n[Microsoft Graph app registration walkthrough](https://learn.microsoft.com/en-us/azure/active-directory-b2c/microsoft-graph-get-started?tabs=app-reg-ga#register-management-application)\n\n[Actionable message card documentation](https://github.com/OfficeDev/outlook-dev-docs/blob/main/docs/actionable-messages/message-card-reference.md)";
				}
				function compiledContent() {
					return html;
				}
				function getHeadings() {
					return [{"depth":2,"slug":"motivation","text":"Motivation"},{"depth":2,"slug":"project-architecture","text":"Project Architecture"},{"depth":3,"slug":"fastapi-setup","text":"FastAPI setup"},{"depth":3,"slug":"python-job","text":"Python Job"},{"depth":2,"slug":"conclusion","text":"Conclusion"},{"depth":2,"slug":"references","text":"References"}];
				}

				const Content = createComponent((result, _props, slots) => {
					const { layout, ...content } = frontmatter;
					content.file = file;
					content.url = url;

					return renderTemplate`${maybeRenderHead()}${unescapeHTML(html)}`;
				});

export { Content, compiledContent, Content as default, file, frontmatter, getHeadings, rawContent, url };
